---
title: linux内存布局和ASLR  
date: 2019-11-04
categories: develop 
author: yawei.zhang 
---
### 内存布局    
###### 基本布局  
内核地址空间范围  [0XFFFF 0000 0000 0000, 0XFFFF FFFF FFFF FFFF]
不规范地址空间    (0XFFFF 0000 0000 0000, 0X0000 FFFF FFFF FFFF)
用户地址空间      [0X0000 FFFF FFFF FFFF, 0X0000 0000 0000 0000]

备注: 用户空间范围对应为0~TASK_SIZE = 2^VA_BITS
1. 用户地址空间默认最大宽度是48 如上  
2. 内核地址空间和用户地址空间宽度相同  
3. 不同的页长默认有不同的宽度, 例如4KB页长默认是39位   16:47, 64:42等, 可直接选择48位.  
4. 开启LVA支持并且页长64可以支持到最大宽度52   
5. 通过getconf PAGE_SIZE 可以查看系统的页大小  
6. 通过/proc/$pid/maps或者pmap可以查看一个进程的实际内存布局 



###### 内核布局   
###### 用户空间布局   
* TASK_SIZE
* 栈空间,  向下增长  具体位置为(STACK_TOP - 随机值), STACK_TOP对应TASK_SIZE  
  * 栈的位置不能超过STACK_TOP的5/6,并且保证128M的栈空间  对齐到页.   
  
* 内存映射区域(mmap) 老版本 TASK_UNMAAPPED_BASE+随机值 向上增长   
* 内存映射区域(mmap) 新版本 STACK_TOP - 栈最大长度 - 间隙 - 随机值  向下增长  x86 2.6.7版本后   
  * 新老版本的差别在于 新版本 堆和内存映射区域向同一个空间增长, 栈有最大长度限制 在32位下通过压缩栈的空间大小可以让堆和内存映射区域获得最大的使用空间.   



* 堆空间(Heap)  brk/sbrk分配

* BSS段(Block Started by Symbol) 未初始化数据段或者初始化为0 的全局变量和静态局部变量    * loader加载程序时, 会将BSS段分配的内存清零, 在目标文件中并不占用空间(目标没有BSS段 只有记录名称和大小).  
  
* 数据段(Data)  已初始化并且非0的全局变量和静态局部变量 
  * 例如int a[10000] = {1,2,3, ...}; 与 int a[10000];
  * 前者在程序中有完整的数据存储, 而后者指标记了使用的大小, 对于目标文件来说会节省非常多的存储空间.   
  
* 代码段(Text)  存放机器指令  只读  
  * 存放
* 保留区
* 0

###### 多线程 
非主线程的栈是mmap出来的 
```

mem = mmap (NULL, size, prot,
            MAP_PRIVATE | MAP_ANONYMOUS | MAP_STACK, -1, 0);
```


### ELF文件装载过程  

### Address space layout randomization 地址空间布局随机化  
  可以防范return-to-libc 这种攻击





##### ASLR在linux中的三个等级以及配置和禁用方法    
* 系统全局配置
```
/proc/sys/kernel/randomize_va_space
0 = Disabled
1 = Conservative Randomization
2 = Full Randomization
```  

1. 关闭  
2. 保守随机化: 共享库 栈 mmap  vdso随机化   
3. 完全随机化:  包括brk分配的内存   
    2.1 代码段和数据段的随机化需要PIE位置无关可执行程序的支持  编译链接时添加 -fpie -pie   

> brk和mmap的分配由glibc确定 默认规则是小于M_MMAP_THRESHOLD宏走brk  但是新系统的算法可能会让大于这个参数的临时分配也走brk   

* 修改/关闭系统配置
```
# sysctl -w kernel.randomize_va_space=0
# echo 0 > /proc/sys/kernel/randomize_va_space
```

* 进程个性化设置: 进程描述符的成员personality设置 ADDR_NO_RANDOMIZE     
  * setarch $(uname -m) -R [--addr-no-randomize] [target exe]
  * 例如 ldd ./benchmark_fast 在aslr环境下会看到每次so的内存位置都在变化   
    * setarch $(uname -m) -R ldd ./benchmark_fast 这样去查看则是固定不变的  



ldd命令  



代码段/数据段的随机化  
gcc 编译时


PIE 位置无关可执行程序  
PIC 

KASLR  内核地址空间布局随机化  



pmap x86一个带共享内存的进程.  00007f1-00007f2之间是64G大小的空间
```
pmap 22621

22621:   ../../???/bin/???  --conf-file=../cfg.xml  
0000000000400000  32460K r-x--  /data/home/???/bin/???
00000000025b3000    724K rw---  /data/home/???/bin/???
0000000002668000  49260K rw---    [ anon ]
0000000006835000  25172K rw---    [ anon ]
00000000080ca000 284456K rw---    [ anon ]
00000000404e9000    128K rw---    [ anon ]
0000000040fe3000    128K rw---    [ anon ]
00007f1000000000 2511808K rw-s-    [ shmid=0x39020085 ]
00007f213db99000      4K -----    [ anon ]
00007f213db9a000   8192K rw---    [ anon ]
00007f213e39a000   7336K r--s-  /dev/shm/???/???.nav
00007f213eac4000   8588K r--s-  /dev/shm/???/???.nav
00007f213f327000   7336K r--s-  /dev/shm/???/???.nav
00007f213fa51000   2052K rw-s-    [ shmid=0x39018084 ]
00007f213fc52000  40964K rw-s-    [ shmid=0x38f40068 ]
00007f2142453000  40964K rw-s-    [ shmid=0x38dd003a ]
00007f2144c54000  40964K rw-s-    [ shmid=0x38db0036 ]
00007f2147455000  40964K rw-s-    [ shmid=0x38d7802f ]
00007f2149c56000  40964K rw-s-    [ shmid=0x38d40028 ]
00007f214c457000  40964K rw-s-    [ shmid=0x38d10022 ]
00007f214ec58000  40964K rw-s-    [ shmid=0x38cf801f ]
00007f2151459000  40964K rw-s-    [ shmid=0x38cb0016 ]
00007f2153c5a000  40964K rw-s-    [ shmid=0x38ca0014 ]
00007f215645b000  40964K rw-s-    [ shmid=0x38c90012 ]
00007f2158c5c000  40964K rw-s-    [ shmid=0x38c7800f ]
00007f215b45d000   1024K rw-s-    [ shmid=0x50806c ]
00007f215b55d000   1576K r-x--  /lib64/libc-2.12.so
00007f215b6e7000   2048K -----  /lib64/libc-2.12.so
00007f215b8e7000     16K r----  /lib64/libc-2.12.so
00007f215b8eb000      4K rw---  /lib64/libc-2.12.so
00007f215b8ec000     20K rw---    [ anon ]
00007f215b8f1000    524K r-x--  /lib64/libm-2.12.so
00007f215b974000   2044K -----  /lib64/libm-2.12.so
00007f215bb73000      4K r----  /lib64/libm-2.12.so
00007f215bb74000      4K rw---  /lib64/libm-2.12.so
00007f215bb75000      8K r-x--  /lib64/libdl-2.12.so
00007f215bb77000   2048K -----  /lib64/libdl-2.12.so
00007f215bd77000      4K r----  /lib64/libdl-2.12.so
00007f215bd78000      4K rw---  /lib64/libdl-2.12.so
00007f215bd79000     92K r-x--  /lib64/libpthread-2.12.so
00007f215bd90000   2048K -----  /lib64/libpthread-2.12.so
00007f215bf90000      4K r----  /lib64/libpthread-2.12.so
00007f215bf91000      4K rw---  /lib64/libpthread-2.12.so
00007f215bf92000     16K rw---    [ anon ]
00007f215bf96000      8K r-x--  /lib64/libutil-2.12.so
00007f215bf98000   2044K -----  /lib64/libutil-2.12.so
00007f215c197000      4K r----  /lib64/libutil-2.12.so
00007f215c198000      4K rw---  /lib64/libutil-2.12.so
00007f215c199000     28K r-x--  /lib64/librt-2.12.so
00007f215c1a0000   2044K -----  /lib64/librt-2.12.so
00007f215c39f000      4K r----  /lib64/librt-2.12.so
00007f215c3a0000      4K rw---  /lib64/librt-2.12.so
00007f215c3a1000    128K r-x--  /lib64/ld-2.12.so
00007f215c43c000      4K rw---    [ anon ]
00007f215c43d000    208K r--s-  /dev/shm/???/???.nav
00007f215c471000    188K rw-s-    [ shmid=0x38c6800d ]
00007f215c4a0000     20K rw---    [ anon ]
00007f215c4a5000     16K rw---    [ anon ]
00007f215c4a9000      4K r--s-  /dev/shm/???/???.nav
00007f215c4aa000      4K r--s-  /dev/shm/???/???.nav
00007f215c4ab000     20K rw---    [ anon ]
00007f215c4b0000      8K rw---    [ anon ]
00007f215c4b2000     20K rw---    [ anon ]
00007f215c4b7000     12K r-x--  /lib64/lib???rity.so.1.0.19
00007f215c4ba000   1024K -----  /lib64/lib???rity.so.1.0.19
00007f215c5ba000      4K rw---  /lib64/lib???ity.so.1.0.19
00007f215c5bb000     16K rw---    [ anon ]
00007f215c5bf000      4K rw---    [ anon ]
00007f215c5c0000      4K r----  /lib64/ld-2.12.so
00007f215c5c1000      4K rw---  /lib64/ld-2.12.so
00007f215c5c2000      4K rw---    [ anon ]
00007ffe6d6d3000    132K rw---    [ stack ]
00007ffe6d7ed000      8K r-x--    [ anon ]
ffffffffff600000      4K r-x--    [ anon ]
 total          3405716K
 ```