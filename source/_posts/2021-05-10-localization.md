
---
title: 计算机的性能优化和局部化
date: 2021-05-10
categories: develop 
author: yawei.zhang 
mathjax: false
---

## 计算机的定量设计原理: Amdahl定律和性能提升的表示方法  
> 在计算机体系结构中，阿姆达尔定律（或阿姆达尔论点[1]）是一个公式，该公式给出了在固定工作负载下任务执行的延迟的理论上的加速，这可以预期其资源得到了改善的系统。它以计算机科学家Gene Amdahl的名字命名，并于1967年在AFIPS春季联合计算机会议上发表。  

其定律可以用以下公式描述: 
$$S = \frac{1} {(1-p) + \frac{p}{s} } $$

$S$ 延迟是整个任务执行的理论上的加速  
$s$ 是任务的一部分得益于改进的系统资源   
$p$ 是受益于最初占用改进资源的部分的执行时间比例    

**该定律的主要思想是: 当我们对系统的某个部分加速时, 其对整体性能的影响取决于该部分的重要性和加速程度.**   
> 例如:  
> 系统某部分的初始耗时比例为60%(s=0.6);  
> 我们对该部分做了重大改进并获得了巨大的性能提升, 获得加速比为3(s=3);
> 但是获得的系统加速比最终为1.67(倍);    

notes:   
> 性能提升最好的表示方法是用比例的形式$T_{old}/T_{new}$, 如果有所改进, 则比值大于1. 一般用后缀"X"表示比例, 例如1.67X, 读作'1.67倍' ;       
> 该表示相对传统百分比方法而言更为清晰:
> > 通常百分比适用于变化小的情况, 并且存在以下模糊的定义部分:    
> > 例如这种变化是用$100*(T_{old}-T_{new})/T_{new}$还是$100*(T_{old}-T_{new})/T_{old}$  ?   
> > 以及与简单的说性能提升为2.2倍, 百分比的120%的性能提升更难理解.   


## 编写高效程序和性能优化   

首先, 写程序最主要的目标是使它在所有可能的情况下都能正确工作,  一个运行的很快但是会给出错误结果的程序没有任何用处.   

但是另外一方面, 很多情景下让程序跑得很快(包括响应速度甚至性能功耗比)也是一个重要的考虑因素, 这在游戏中的gameplay部分体现的淋漓尽致.  

编写高效程序需要做到以下几点:  
* 高级设计: 选择合适的算法和数据结构     
* 编码原则: 编写编译器能识别并优化成高效可执行代码的源代码;(隐含理解编译器优化的局限性)   
* 低级优化: 充分利用硬件的功能并充分发挥硬件的性能.    


程序优化的步骤:  
* 确认并分析性能瓶颈  
* 理解工作的目标, 并重新审视工作代码是否遵循'编写高效程序'的几个基本要点.  
* 选择合适的算法和数据结构, 必要时根据时间和人力成本是否需要重构设计.    
* 消除不必要的工作, 包括不必要的设计和流程, 不必要的代码和调用   
* 对热点代码进行针对硬件特性的低级优化, 减少对硬件不友好的代码, 尽可能的发挥硬件的性能.   


对已有代码优化的几个基本原则:  
* 执行安全的优化, 而不是通过牺牲正确性来得到一个跑的很快看起来正确但从形式逻辑上而言存在错误的代码, 哪怕在我们通过边界的特殊保护后'保证'了'这段'代码的正确执行.     
* 同上, 尽可能的避免带有副作用的优化, 特别是副作用的描述比较隐晦的情况.   
* 注意好优化的层次顺序以及核心所在, 避免没必要的过度优化以及优化所带来的各种成本      

根据原则举例几种情况(优先使用更优的优化路径解决性能问题):   

* 如非必要, 尽可能进行局部的替换和改善, 减少优化带来的修改规模.   
* 如非必要, 尽可能的使用简洁的代码, 避免优化带来的可读性损失   
* 如非必要, 尽可能保持代码的通用性, 尽可能少的牺牲可扩展性和灵活性.  




notes:   
> 如何保证的程序的正确性, 参见'安全编程';   


### 局部性原理  
在计算机科学的发展过程中 贯穿软件和硬件, 几乎无差别覆盖所有对性能和延迟有要求的应用领域, 一次又一次拯救了性能瓶颈危机, 各类优化的基石. 或许很少提及但却一直在使用和遵循的原理... 局部性原理.   

* 硬件的发展, CPU性能的提升和存储硬件的性能提升差异   
* CPU的分支预测, 指令集并行, Memory Hierarchy, 多核技术  
* 数据库的实质   
* 游戏中的同步模型   
* 视频的压缩技术   
* 内存分配器和meta设计  
  

