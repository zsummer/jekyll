---
title: PLT procedure linkage table  过程链接表    
date: 2019-11-25
categories: develop 
author: yawei.zhang 
---

### 目录  

<!-- TOC -->
- [目录](#目录)
- [调测工具](#调测工具)
- [汇编和寄存器说明](#汇编和寄存器说明)
- [PLT基本定义和流程说明](#plt基本定义和流程说明)
- [GOT数据部分](#got数据部分)
      - [缺点](#缺点)
      - [优点](#优点)
- [测试代码](#测试代码)
- [elf文件和指令分析](#elf文件和指令分析)
<!-- /TOC -->


### 调测工具   

readelf -a  查看elf信息  
objdump -S 查看汇编指令  
ldd 查看动态加载   
gdb 通过```layout regs```打开寄存器显示, 通过```set disassemble-next-line on```打开汇编  
gdb 通过peda插件字节显示汇编和寄存器  和上面的原生方式选择一个即可    
gdb关闭ASLR：
set disable-randomization on
开启ASLR：
set disable-randomization off
查看ASLR状态：
show disable-randomization

<!-- more -->
### 汇编和寄存器说明  

"@"符号表示“将符号左边的变量钳制在符号右边的地址

* 寄存器单位  
  * E开头是32位  
  * R开头是64位  
  
* 一般寄存器:AX BX CX DX
  * AX:累积寄存器 是加法乘法指令的缺省寄存器
  * BX:基底寄存器 内存寻址时存放基地址
  * CX:计数寄存器 是重复(REP)前缀指令和LOOP指令的内定计数器  
  * DX:资料寄存器 用来放整数除法产生的余数  

* 索引寄存器:SI DI  源/目标索引寄存器"(source/destination index)  
  * SI:来源索引寄存器  字符串操作指令中, DS:ESI指向源串  
  * DI:目的索引寄存器  字符串操作指令中, ES:EDI指向目标串

* 指针寄存器
  * SP:堆栈指针寄存器 专门用作堆栈指针 被形象地称为栈顶指针  
  * BP:基址指针寄存器 经常被用作高级语言函数调用的"框架指针|栈帧指针"(frame pointer)  
    * 在EBP上方分别是原来的EBP 返回地址 参数  
    * EBP下方是(函数)的临时变量  
  * IP: 指令指针 Instruction Pointer 存放下次将要执行的指令在代码段的偏移量 (不考虑预读队列)  
    * 概念上是PC 程序计数器  X86体系下叫IP 


### PLT基本定义和流程说明   

1. 为本地的函数生成对应的 函数符号.plt 命名的过程  
2. 为本地的符号生成带偏移信息的符号表  
3. 每个映像文件都生成一个GOT表, 第一项保存基址位置, 第二项保存link_map, link_map通过前后指针把所有映像文件(库)和符号表串联起来   
4. 运行时对位置无关的函数和全局变量的访问通过GOT表访问   
5. GOT表会在模块加载时候填充好变量的真正地址以及plt过程的惰性获取代码入口    
   1. PLT过程 类似函数钩子 
      1. 本模块对位置无关的函数访问先call 函数@.plt过程  
      2. 该过程会先直接跳转到GOT中对应位置保存的地址处  
         1. 如果未获取实际位置, 则跳转到到该过程的下一行代码   
         2. 压入当前函数符号在GOT中的编号并jmp到符号解析函数_dl_runtime_resolve_xsave进行解析  
         3. 通过link_map进行遍历查找 _dl_fixup 
         4. 填充GOT表
         5. (这里实际会call到真实函数并返回到call 函数@.plt的位置)  
      3. 进入实际函数执行并返回到 call 函数@.plt的位置

### GOT数据部分   
不需要PLT的额外部分   

###### 缺点  
为了性能需要一个寄存器存储GOT表的位置??? 
运行时要经过计算来获得
符号的地址, 从某种方面来说也对运行速度有点小影响.  

###### 优点
位置无关代码的优点就跟他名字一样, 可以保证加载到任意地址都能
正常执行, 这也是每个动态链接库都需要支持的.

### 测试代码   

### elf文件和指令分析   
[rip+0x2006e4]        # 0x555555754fd8  0x00007ffff7dd7048
[rip+0x2006d0]        # 0x555555754fd0  0x00007ffff7dd7030

[rip+0x20074f]        # 0x7ffff7dd6fc8  0x00007ffff7dd7050
[rip+0x20073b]        # 0x7ffff7dd6fc0  0x00007ffff7dd7038


[rip+0x20073e]        # 0x7ffff7dd6fd8  0x00007ffff7dd7030
[rip+0x20073a]        # 0x7ffff7dd6fe0  0x00007ffff7dd7048


